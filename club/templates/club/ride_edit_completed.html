{% extends 'club/base.html' %}

{% block title %}Edit {{ ride.title }} - Costa Brava Bikers{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">Edit Completed Ride</h1>
        <p class="text-gray-600">{{ ride.title }} - {{ ride.date_time|date:"F j, Y" }}</p>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-100 border-red-400 text-red-700{% elif message.tags == 'success' %}bg-green-100 border-green-400 text-green-700{% else %}bg-blue-100 border-blue-400 text-blue-700{% endif %} border px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Column: Forms -->
        <div class="space-y-6">
            {% if user.is_staff %}
            <!-- Admin: Full Ride Edit Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6">Edit Ride Details</h2>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
                        <input type="text" id="title" name="title" value="{{ ride.title }}" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                        <textarea id="description" name="description" rows="4" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ ride.description }}</textarea>
                    </div>

                    <div class="mb-4">
                        <label for="date_time" class="block text-sm font-medium text-gray-700 mb-2">Date & Time *</label>
                        <input type="datetime-local" id="date_time" name="date_time" value="{{ ride.date_time|date:'Y-m-d\TH:i' }}" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="start_point" class="block text-sm font-medium text-gray-700 mb-2">Start Point *</label>
                            <input type="text" id="start_point" name="start_point" value="{{ ride.start_point }}" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="end_point" class="block text-sm font-medium text-gray-700 mb-2">End Point *</label>
                            <input type="text" id="end_point" name="end_point" value="{{ ride.end_point }}" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="calimoto_url" class="block text-sm font-medium text-gray-700 mb-2">Calimoto URL</label>
                        <input type="url" id="calimoto_url" name="calimoto_url" value="{{ ride.calimoto_url }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="relive_url" class="block text-sm font-medium text-gray-700 mb-2">Relive URL</label>
                        <input type="url" id="relive_url" name="relive_url" value="{{ ride.relive_url }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="header_photo" class="block text-sm font-medium text-gray-700 mb-2">Header Photo</label>
                        {% if ride.header_photo %}
                        <div class="mb-2">
                            <img src="{{ ride.header_photo.url }}" alt="Current header" class="h-32 rounded-md object-cover">
                            <p class="text-sm text-gray-500 mt-1">Current header photo</p>
                        </div>
                        {% endif %}
                        <input type="file" id="header_photo" name="header_photo" accept="image/*"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="gpx_file" class="block text-sm font-medium text-gray-700 mb-2">GPX File</label>
                        {% if ride.gpx_file %}
                        <div class="mb-2">
                            <a href="{{ ride.gpx_file.url }}" class="text-blue-600 hover:underline text-sm" download>ðŸ“„ Current GPX file</a>
                        </div>
                        {% endif %}
                        <input type="file" id="gpx_file" name="gpx_file" accept=".gpx"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md transition">
                        Save Ride Details
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Photo Upload Form (All logged-in users) -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6">Add Photos</h2>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="photo" class="block text-sm font-medium text-gray-700 mb-2">Select Photo *</label>
                        <input type="file" id="photo" name="photo" accept="image/*" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="caption" class="block text-sm font-medium text-gray-700 mb-2">Caption (optional)</label>
                        <textarea id="caption" name="caption" rows="2" placeholder="Add a description for this photo..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-md transition">
                        Upload Photo
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column: Photo Gallery -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6">Photo Gallery ({{ photos.count }})</h2>
            
            {% if photos %}
            <div class="space-y-6">
                {% for photo in photos %}
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <img src="{{ photo.photo.url }}" alt="Ride photo" class="w-full h-64 object-cover">
                    <div class="p-4">
                        {% if photo.caption %}
                        <p class="text-gray-700 mb-2">{{ photo.caption }}</p>
                        {% endif %}
                        <div class="flex justify-between items-center text-sm text-gray-500">
                            <span>ðŸ“¸ by {{ photo.uploaded_by.username }} on {{ photo.created_at|date:"M j, Y" }}</span>
                            {% if user.is_staff or photo.uploaded_by == user %}
                            <form method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this photo?');">
                                {% csrf_token %}
                                <button type="submit" name="delete_photo" value="{{ photo.id }}" 
                                        class="text-red-600 hover:text-red-800 font-medium">
                                    Delete
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <p class="text-gray-500 text-lg">No photos yet</p>
                <p class="text-gray-400 mt-2">Be the first to add photos from this ride!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-8 text-center">
        <a href="{% url 'club:ride_detail' ride.pk %}" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-md transition">
            Back to Ride Details
        </a>
    </div>
</div>
{% endblock %}
